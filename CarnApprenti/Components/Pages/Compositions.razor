@page "/compositions"
@using Microsoft.AspNetCore.Components.Forms
@using static CarnApprenti.LivretApprentissageContext
@inject DatabaseService DatabaseService
@inject NavigationManager Navigation
@inject Blazored.SessionStorage.ISessionStorageService SessionStorage
@inject IJSRuntime js

<button class="btn btn-secondary" @onclick="GoBack">← Retour</button>

<h1 class="text-center m-4">Gestion des Compositions</h1>

@if (isLoading)
{
    <div class="text-center">
        <h2>Chargement en cours...</h2>
    </div>
}
else
{
    <div class="container_bouton">
        <a class="btn btn-primary" href="add_composition">Ajouter une composition</a>
    </div>

    @if (compositions != null && compositions.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr class="text-center">
                        <th>Nom</th>
                        <th>Lien</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody class="text-white">
                    @foreach (var composition in compositions)
                    {
                        <tr class="text-center">
                            <td>@composition.Nom</td>
                            <td>
                                <a href="@composition.Lien" target="_blank">Voir la composition</a>
                            </td>
                            <td>
                                <a class="btn btn-warning btn-sm m-2" href="edit_composition/@composition.Id">Modifier</a>
                                <button class="btn btn-danger btn-sm m-2" @onclick="() => DeleteComposition(composition.Id)">Supprimer</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <p class="text-center alert alert-warning">Aucune composition disponible.</p>
    }
}

@code {
    private bool isLoading = true;
    private List<Composition> compositions = new List<Composition>();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        try
        {
            compositions = await DatabaseService.GetCompositionsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du chargement des compositions : {ex.Message}");
        }

        isLoading = false;
    }

    private async Task DeleteComposition(ulong compositionId)
    {
        // Confirmation avant de supprimer
        bool confirmed = await js.InvokeAsync<bool>("confirm", "Êtes-vous sûr de vouloir supprimer cette composition ?");
        if (confirmed)
        {
            try
            {
                await DatabaseService.DeleteCompositionAsync(compositionId);
                compositions = await DatabaseService.GetCompositionsAsync(); // Recharger les compositions après suppression
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Erreur lors de la suppression de la composition : {ex.Message}");
            }
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/"); // Retour à la page d'accueil
    }
}
