@page "/add_livret"
@using Microsoft.AspNetCore.Components.Forms
@using static CarnApprenti.LivretApprentissageContext
@inject DatabaseService DatabaseService
@inject NavigationManager Navigation
@inject IJSRuntime js

<button class="btn btn-secondary" @onclick="GoBack">← Retour</button>

<h1 class="text-center mb-4">Ajouter un livret</h1>

@if (isLoading)
{
    <div class="text-center">
        <h2>Chargement des données...</h2>
    </div>
}
else
{
    <EditForm Model="livret" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group mb-4">
            <label for="modeleId" class="form-label">Choisir un modèle</label>
            <InputSelect id="modeleId" class="form-control" @bind-Value="livret.ModeleId">
                <option value="">Sélectionner un modèle</option>
                @foreach (var modele in modeles)
                {
                    <option value="@modele.Id">@modele.Nom</option>
                }
            </InputSelect>
        </div>

        <div class="form-group mb-4">
            <label for="userId" class="form-label">Choisir un apprenant</label>
            <InputSelect id="userId" class="form-control" @bind-Value="livret.UserId">
                <option value="">Sélectionner un apprenant</option>
                @foreach (var apprenant in apprenants)
                {
                    <option value="@apprenant.Id">@apprenant.Nom @apprenant.Prenom</option>
                }
            </InputSelect>
        </div>

        <div class="d-flex justify-content-center">
            <button type="submit" class="btn btn-primary btn-lg">Ajouter</button>
        </div>
    </EditForm>
}

@code {
    private bool isLoading = true;
    private Livret livret = new Livret();  // Assurez-vous que livret est correctement initialisé.
    private List<Modele> modeles = new List<Modele>();
    private List<User> apprenants = new List<User>();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        try
        {
            modeles = await DatabaseService.GetModelesAsync(); // Charger les modèles
            apprenants = await DatabaseService.GetApprenantsAsync(); // Charger les utilisateurs

            // Initialiser les valeurs pour afficher "Sélectionner un modèle" et "Sélectionner un apprenant"
            livret.ModeleId = null;
            livret.UserId = null;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du chargement des données : {ex.Message}");
        }

        isLoading = false;
    }

    private async Task HandleSubmit()
    {
        try
        {
            livret.CreatedAt = DateTime.Now;
            // Ajouter le livret à la base de données
            await DatabaseService.AddLivretAsync(livret);

            // Rediriger vers la page de gestion des livrets après l'ajout
            Navigation.NavigateTo("/livrets");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de l'ajout du livret : {ex.Message}");
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/livrets");
    }
}
